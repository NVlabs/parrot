name: Gitemoji Injection

on:
  push:
    branches: [ main, develop ]

jobs:
  gitemoji-injection:
    runs-on: ubuntu-latest
    # Only run on the main NVLabs/parrot repository, not on forks
    if: github.repository == 'NVLabs/parrot'
    
    permissions:
      contents: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for commit analysis
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install gitmojis
        
    - name: Inject gitemojis into recent commits
      run: |
        # Create the gitemoji injection script
        cat > inject-gitemoji.js << 'EOF'
        const fs = require('fs');
        const { execSync } = require('child_process');
        
        // Comprehensive gitemoji mappings based on official gitmoji spec
        const gitemojis = {
          // Conventional commit types (primary mappings)
          'feat': '‚ú®',      // :sparkles: Introduce new features
          'fix': 'üêõ',       // :bug: Fix a bug
          'docs': 'üìù',      // :memo: Add or update documentation
          'style': 'üé®',     // :art: Improve structure / format of the code
          'refactor': '‚ôªÔ∏è',  // :recycle: Refactor code
          'perf': '‚ö°Ô∏è',     // :zap: Improve performance
          'test': '‚úÖ',      // :white_check_mark: Add, update, or pass tests
          'chore': 'üîß',     // :wrench: Add or update configuration files
          'ci': 'üë∑',        // :construction_worker: Add or update CI build system
          'build': 'üì¶Ô∏è',    // :package: Add or update compiled files or packages
          'revert': '‚è™Ô∏è',   // :rewind: Revert changes
          
          // Specific action keywords
          'hotfix': 'üöëÔ∏è',   // :ambulance: Critical hotfix
          'security': 'üîíÔ∏è', // :lock: Fix security or privacy issues
          'secrets': 'üîê',   // :closed_lock_with_key: Add or update secrets
          'release': 'üîñ',   // :bookmark: Release / Version tags
          'deploy': 'üöÄ',    // :rocket: Deploy stuff
          'wip': 'üöß',       // :construction: Work in progress
          'warning': 'üö®',   // :rotating_light: Fix compiler / linter warnings
          'lint': 'üö®',      // :rotating_light: Fix compiler / linter warnings
          'breaking': 'üí•',  // :boom: Introduce breaking changes
          'deprecate': 'üóëÔ∏è', // :wastebasket: Deprecate code that needs to be cleaned up
          'remove': 'üî•',    // :fire: Remove code or files
          'move': 'üöö',      // :truck: Move or rename resources
          'rename': 'üöö',    // :truck: Move or rename resources
          'typo': '‚úèÔ∏è',      // :pencil2: Fix typos
          'merge': 'üîÄ',     // :twisted_rightwards_arrows: Merge branches
          'experiment': '‚öóÔ∏è', // :alembic: Perform experiments
          'mock': 'ü§°',      // :clown_face: Mock things
          'easter': 'ü•ö',    // :egg: Add or update an easter egg
          'snapshot': 'üì∏',  // :camera_flash: Add or update snapshots
          'seed': 'üå±',      // :seedling: Add or update seed files
          'flag': 'üö©',      // :triangular_flag_on_post: Add, update, or remove feature flags
          'catch': 'ü•Ö',     // :goal_net: Catch errors
          'animation': 'üí´', // :dizzy: Add or update animations and transitions
          'auth': 'üõÇ',      // :passport_control: Work on code related to authorization
          'bandage': 'ü©π',   // :adhesive_bandage: Simple fix for a non-critical issue
          'explore': 'üßê',   // :monocle_face: Data exploration/inspection
          'dead': '‚ö∞Ô∏è',     // :coffin: Remove dead code
          'failing': 'üß™',   // :test_tube: Add a failing test
          'business': 'üëî',  // :necktie: Add or update business logic
          'health': 'ü©∫',    // :stethoscope: Add or update healthcheck
          'infrastructure': 'üß±', // :bricks: Infrastructure related changes
          'dx': 'üßë‚Äçüíª',      // :technologist: Improve developer experience
          'sponsor': 'üí∏',   // :money_with_wings: Add sponsorships or money related infrastructure
          'thread': 'üßµ',    // :thread: Add or update code related to multithreading
          'validation': 'ü¶∫', // :safety_vest: Add or update code related to validation
          'offline': '‚úàÔ∏è',   // :airplane: Improve offline support
          
          // Dependencies
          'upgrade': '‚¨ÜÔ∏è',   // :arrow_up: Upgrade dependencies
          'downgrade': '‚¨áÔ∏è', // :arrow_down: Downgrade dependencies
          'pin': 'üìå',       // :pushpin: Pin dependencies to specific versions
          'add-dep': '‚ûï',   // :heavy_plus_sign: Add a dependency
          'remove-dep': '‚ûñ', // :heavy_minus_sign: Remove a dependency
          
          // File-based patterns
          'cmake': 'üì¶Ô∏è',    // :package: CMake files (build system)
          'docker': 'üê≥',   // :whale: Docker files
          'dockerfile': 'üê≥', // :whale: Docker files
          'github': 'üë∑',   // :construction_worker: GitHub workflows
          'readme': 'üìù',   // :memo: README files
          'license': 'üìÑ',  // :page_facing_up: License files
          'gitignore': 'üôà', // :see_no_evil: .gitignore
          'ui': 'üíÑ',       // :lipstick: UI and style files
          'css': 'üíÑ',      // :lipstick: UI and style files
          'html': 'üíÑ',     // :lipstick: UI and style files
          'database': 'üóÉÔ∏è', // :card_file_box: Database related changes
          'db': 'üóÉÔ∏è',       // :card_file_box: Database related changes
          'log': 'üîä',      // :loud_sound: Add or update logs
          'logging': 'üîä',  // :loud_sound: Add or update logs
          'analytics': 'üìà', // :chart_with_upwards_trend: Add or update analytics
          'i18n': 'üåê',     // :globe_with_meridians: Internationalization
          'locale': 'üåê',   // :globe_with_meridians: Internationalization
          'responsive': 'üì±', // :iphone: Work on responsive design
          'mobile': 'üì±',   // :iphone: Work on responsive design
          'seo': 'üîçÔ∏è',     // :mag: Improve SEO
          'types': 'üè∑Ô∏è',   // :label: Add or update types
          'typescript': 'üè∑Ô∏è', // :label: Add or update types
          'accessibility': '‚ôøÔ∏è', // :wheelchair: Improve accessibility
          'a11y': '‚ôøÔ∏è',     // :wheelchair: Improve accessibility
          'ux': 'üö∏',       // :children_crossing: Improve user experience
          'usability': 'üö∏', // :children_crossing: Improve user experience
          'architecture': 'üèóÔ∏è', // :building_construction: Make architectural changes
          'contributor': 'üë•', // :busts_in_silhouette: Add or update contributor(s)
          'comment': 'üí°',  // :bulb: Add or update comments in source code
          'comments': 'üí°', // :bulb: Add or update comments in source code
          'text': 'üí¨',     // :speech_balloon: Add or update text and literals
          'assets': 'üç±',   // :bento: Add or update assets
          
          // CUDA/GPU specific (keep existing CUDA mappings)
          'cuda': 'üöÄ',     // :rocket: CUDA files (deploy/performance context)
          'gpu': '‚ö°Ô∏è',     // :zap: GPU related (performance context)
          'kernel': '‚ö°Ô∏è',  // :zap: Kernel optimizations (performance context)
          
          // General action words (fallbacks)
          'update': '‚¨ÜÔ∏è',   // :arrow_up: General updates (upgrade context)
          'add': '‚ûï',      // :heavy_plus_sign: Adding files (dependency context)
          'delete': 'üî•',   // :fire: Removing files
          'initial': 'üéâ', // :tada: Initial commit
          'init': 'üéâ',    // :tada: Initial commit
          'start': 'üéâ',   // :tada: Begin a project
        };
        
        function hasGitemoji(message) {
          // Check if message already contains an emoji
          const emojiRegex = /[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u;
          return emojiRegex.test(message);
        }
        
        function detectCommitType(message, files) {
          const lowerMessage = message.toLowerCase();
          
          // Check conventional commit format first
          const conventionalMatch = message.match(/^(\w+)(\(.+\))?:/);
          if (conventionalMatch) {
            const type = conventionalMatch[1].toLowerCase();
            if (gitemojis[type]) {
              return gitemojis[type];
            }
          }
          
          // Check for specific keywords in message
          for (const [keyword, emoji] of Object.entries(gitemojis)) {
            if (lowerMessage.includes(keyword)) {
              return emoji;
            }
          }
          
          // Analyze changed files
          if (files) {
            if (files.some(f => f.includes('.cu') || f.includes('.cuh'))) {
              return gitemojis['cuda'];
            }
            if (files.some(f => f.includes('CMakeLists.txt') || f.includes('.cmake'))) {
              return gitemojis['cmake'];
            }
            if (files.some(f => f.includes('.github'))) {
              return gitemojis['github'];
            }
            if (files.some(f => f.toLowerCase().includes('readme'))) {
              return gitemojis['readme'];
            }
            if (files.some(f => f.includes('test'))) {
              return gitemojis['test'];
            }
            if (files.some(f => f.includes('doc'))) {
              return gitemojis['docs'];
            }
          }
          
          // Default based on action words
          if (lowerMessage.includes('add') || lowerMessage.includes('new')) {
            return gitemojis['add'];
          }
          if (lowerMessage.includes('remove') || lowerMessage.includes('delete')) {
            return gitemojis['remove'];
          }
          if (lowerMessage.includes('update') || lowerMessage.includes('modify')) {
            return gitemojis['update'];
          }
          if (lowerMessage.includes('initial') || lowerMessage.includes('first')) {
            return gitemojis['initial'];
          }
          
          // Default fallback
          return gitemojis['update'];
        }
        
        try {
          // Configure git user for the action
          execSync('git config user.name "github-actions[bot]"');
          execSync('git config user.email "github-actions[bot]@users.noreply.github.com"');
          
          // Get commits from the push event
          const pushEvent = process.env.GITHUB_EVENT_PATH ? 
            JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8')) : {};
          
          // Get the range of commits from the push event
          const beforeSha = pushEvent.before;
          const afterSha = pushEvent.after || 'HEAD';
          
          console.log(`üîç Analyzing commits from ${beforeSha?.substring(0, 7)} to ${afterSha.substring(0, 7)}`);
          
          // Get all commits in the push
          let commitRange;
          if (beforeSha && beforeSha !== '0000000000000000000000000000000000000000') {
            commitRange = `${beforeSha}..${afterSha}`;
          } else {
            // First push to branch, just get the latest commit
            commitRange = 'HEAD~1..HEAD';
          }
          
          const commits = execSync(`git rev-list --reverse ${commitRange}`, { encoding: 'utf8' })
            .trim().split('\n').filter(sha => sha);
          
          console.log(`üìã Found ${commits.length} commits to process`);
          
          let updatedCount = 0;
          const commitsToUpdate = [];
          
          // First pass: identify commits that need gitemojis
          for (const sha of commits) {
            try {
              const commitMessage = execSync(`git log -1 --pretty=%B ${sha}`, { encoding: 'utf8' }).trim();
              
              console.log(`\nüîç Checking commit ${sha.substring(0, 7)}: ${commitMessage.split('\n')[0]}`);
              
              // Skip if already has gitemoji
              if (hasGitemoji(commitMessage)) {
                console.log('‚úÖ Already has gitemoji, skipping');
                continue;
              }
              
              // Get changed files in this commit
              let changedFiles = [];
              try {
                changedFiles = execSync(`git diff-tree --no-commit-id --name-only -r ${sha}`, { encoding: 'utf8' })
                  .trim().split('\n').filter(f => f);
              } catch (e) {
                console.log('Could not get changed files, proceeding without file analysis');
              }
              
              // Detect appropriate gitemoji
              const emoji = detectCommitType(commitMessage, changedFiles);
              const newMessage = emoji + ' ' + commitMessage;
              
              console.log(`üìù Original: ${commitMessage.split('\n')[0]}`);
              console.log(`‚ú® New: ${newMessage.split('\n')[0]}`);
              console.log(`üìÅ Files: ${changedFiles.join(', ')}`);
              
              commitsToUpdate.push({
                sha: sha,
                originalMessage: commitMessage,
                newMessage: newMessage,
                files: changedFiles
              });
              
            } catch (error) {
              console.log(`‚ö†Ô∏è Error processing commit ${sha.substring(0, 7)}: ${error.message}`);
            }
          }
          
          if (commitsToUpdate.length === 0) {
            console.log('\nüéâ All commits already have gitemojis!');
            return;
          }
          
          console.log(`\nüîÑ Updating ${commitsToUpdate.length} commits with gitemojis...`);
          
          // Use git filter-branch to rewrite commit messages
          const tempBranch = `gitemoji-temp-${Date.now()}`;
          
          try {
            // Create a temporary branch
            execSync(`git checkout -b ${tempBranch}`);
            
            // Create a script for the message filter
            let filterScript = '#!/bin/bash\ncase "$GIT_COMMIT" in\n';
            
            for (const commit of commitsToUpdate) {
              const escapedMessage = commit.newMessage.replace(/'/g, "'\"'\"'").replace(/\n/g, '\\n');
              filterScript += `  ${commit.sha}) echo '${escapedMessage}' ;;\n`;
            }
            
            filterScript += '  *) cat ;;\nesac\n';
            
            fs.writeFileSync('/tmp/gitemoji-filter.sh', filterScript);
            execSync('chmod +x /tmp/gitemoji-filter.sh');
            
            // Apply the filter to rewrite commit messages
            const startCommit = commits[0];
            execSync(`git filter-branch -f --msg-filter '/tmp/gitemoji-filter.sh' ${startCommit}~1..HEAD`, { stdio: 'inherit' });
            
            // Switch back to original branch and merge the changes
            execSync(`git checkout ${process.env.GITHUB_REF_NAME.replace('refs/heads/', '')}`);
            execSync(`git reset --hard ${tempBranch}`);
            
            // Clean up temporary branch
            execSync(`git branch -D ${tempBranch}`);
            
            updatedCount = commitsToUpdate.length;
            console.log(`‚úÖ Successfully updated ${updatedCount} commit(s) with gitemojis!`);
            
          } catch (filterError) {
            console.log('‚ö†Ô∏è Filter-branch failed, trying alternative approach...');
            
            // Fallback: try to update commits one by one using rebase
            try {
              // Clean up if we created a temp branch
              try { execSync(`git checkout ${process.env.GITHUB_REF_NAME.replace('refs/heads/', '')}`); } catch {}
              try { execSync(`git branch -D ${tempBranch}`); } catch {}
              
              // For now, just update the most recent commit that needs updating
              if (commitsToUpdate.length > 0) {
                const lastCommit = commitsToUpdate[commitsToUpdate.length - 1];
                if (lastCommit.sha === afterSha || lastCommit.sha === commits[commits.length - 1]) {
                  fs.writeFileSync('/tmp/new_commit_message.txt', lastCommit.newMessage);
                  execSync('git commit --amend -F /tmp/new_commit_message.txt');
                  updatedCount = 1;
                  console.log('‚úÖ Updated most recent commit as fallback');
                }
              }
            } catch (fallbackError) {
              console.log('‚ö†Ô∏è Fallback also failed:', fallbackError.message);
            }
          }
          
          if (updatedCount > 0) {
            // Force push the updated commits
            execSync(`git push --force-with-lease origin ${process.env.GITHUB_REF_NAME.replace('refs/heads/', '')}`);
            console.log('‚úÖ Pushed updated commits');
          }
          
        } catch (error) {
          console.error('‚ùå Error:', error.message);
          // Don't fail the workflow for gitemoji issues
          console.log('‚ö†Ô∏è Continuing without gitemoji injection');
        }
        EOF
        
        # Run the gitemoji injection
        node inject-gitemoji.js
