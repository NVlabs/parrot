name: Gitemoji Analysis

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  gitemoji-suggestion:
    runs-on: ubuntu-latest
    # Only run on the main NVLabs/parrot repository, not on forks
    if: github.repository == 'NVLabs/parrot'
    
    permissions:
      pull-requests: write
      
    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for commit analysis
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install gitmojis
        
    - name: Analyze commits for gitemoji suggestions
      run: |
        # Create the gitemoji analysis script
        cat > analyze-gitemoji.js << 'EOF'
        const fs = require('fs');
        const { execSync } = require('child_process');
        
        // Comprehensive gitemoji mappings based on official gitmoji spec
        const gitemojis = {
          // Conventional commit types (primary mappings)
          'feat': 'âœ¨',      // :sparkles: Introduce new features
          'fix': 'ðŸ›',       // :bug: Fix a bug
          'docs': 'ðŸ“',      // :memo: Add or update documentation
          'style': 'ðŸŽ¨',     // :art: Improve structure / format of the code
          'refactor': 'â™»ï¸',  // :recycle: Refactor code
          'perf': 'âš¡ï¸',     // :zap: Improve performance
          'test': 'âœ…',      // :white_check_mark: Add, update, or pass tests
          'chore': 'ðŸ”§',     // :wrench: Add or update configuration files
          'ci': 'ðŸ‘·',        // :construction_worker: Add or update CI build system
          'build': 'ðŸ“¦ï¸',    // :package: Add or update compiled files or packages
          'revert': 'âªï¸',   // :rewind: Revert changes
          
          // Specific action keywords
          'hotfix': 'ðŸš‘ï¸',   // :ambulance: Critical hotfix
          'security': 'ðŸ”’ï¸', // :lock: Fix security or privacy issues
          'secrets': 'ðŸ”',   // :closed_lock_with_key: Add or update secrets
          'release': 'ðŸ”–',   // :bookmark: Release / Version tags
          'deploy': 'ðŸš€',    // :rocket: Deploy stuff
          'wip': 'ðŸš§',       // :construction: Work in progress
          'warning': 'ðŸš¨',   // :rotating_light: Fix compiler / linter warnings
          'lint': 'ðŸš¨',      // :rotating_light: Fix compiler / linter warnings
          'breaking': 'ðŸ’¥',  // :boom: Introduce breaking changes
          'deprecate': 'ðŸ—‘ï¸', // :wastebasket: Deprecate code that needs to be cleaned up
          'remove': 'ðŸ”¥',    // :fire: Remove code or files
          'move': 'ðŸšš',      // :truck: Move or rename resources
          'rename': 'ðŸšš',    // :truck: Move or rename resources
          'typo': 'âœï¸',      // :pencil2: Fix typos
          'merge': 'ðŸ”€',     // :twisted_rightwards_arrows: Merge branches
          'experiment': 'âš—ï¸', // :alembic: Perform experiments
          'mock': 'ðŸ¤¡',      // :clown_face: Mock things
          'easter': 'ðŸ¥š',    // :egg: Add or update an easter egg
          'snapshot': 'ðŸ“¸',  // :camera_flash: Add or update snapshots
          'seed': 'ðŸŒ±',      // :seedling: Add or update seed files
          'flag': 'ðŸš©',      // :triangular_flag_on_post: Add, update, or remove feature flags
          'catch': 'ðŸ¥…',     // :goal_net: Catch errors
          'animation': 'ðŸ’«', // :dizzy: Add or update animations and transitions
          'auth': 'ðŸ›‚',      // :passport_control: Work on code related to authorization
          'bandage': 'ðŸ©¹',   // :adhesive_bandage: Simple fix for a non-critical issue
          'explore': 'ðŸ§',   // :monocle_face: Data exploration/inspection
          'dead': 'âš°ï¸',     // :coffin: Remove dead code
          'failing': 'ðŸ§ª',   // :test_tube: Add a failing test
          'business': 'ðŸ‘”',  // :necktie: Add or update business logic
          'health': 'ðŸ©º',    // :stethoscope: Add or update healthcheck
          'infrastructure': 'ðŸ§±', // :bricks: Infrastructure related changes
          'dx': 'ðŸ§‘â€ðŸ’»',      // :technologist: Improve developer experience
          'sponsor': 'ðŸ’¸',   // :money_with_wings: Add sponsorships or money related infrastructure
          'thread': 'ðŸ§µ',    // :thread: Add or update code related to multithreading
          'validation': 'ðŸ¦º', // :safety_vest: Add or update code related to validation
          'offline': 'âœˆï¸',   // :airplane: Improve offline support
          
          // Dependencies
          'upgrade': 'â¬†ï¸',   // :arrow_up: Upgrade dependencies
          'downgrade': 'â¬‡ï¸', // :arrow_down: Downgrade dependencies
          'pin': 'ðŸ“Œ',       // :pushpin: Pin dependencies to specific versions
          'add-dep': 'âž•',   // :heavy_plus_sign: Add a dependency
          'remove-dep': 'âž–', // :heavy_minus_sign: Remove a dependency
          
          // File-based patterns
          'cmake': 'ðŸ“¦ï¸',    // :package: CMake files (build system)
          'docker': 'ðŸ³',   // :whale: Docker files
          'dockerfile': 'ðŸ³', // :whale: Docker files
          'github': 'ðŸ‘·',   // :construction_worker: GitHub workflows
          'readme': 'ðŸ“',   // :memo: README files
          'license': 'ðŸ“„',  // :page_facing_up: License files
          'gitignore': 'ðŸ™ˆ', // :see_no_evil: .gitignore
          'ui': 'ðŸ’„',       // :lipstick: UI and style files
          'css': 'ðŸ’„',      // :lipstick: UI and style files
          'html': 'ðŸ’„',     // :lipstick: UI and style files
          'database': 'ðŸ—ƒï¸', // :card_file_box: Database related changes
          'db': 'ðŸ—ƒï¸',       // :card_file_box: Database related changes
          'log': 'ðŸ”Š',      // :loud_sound: Add or update logs
          'logging': 'ðŸ”Š',  // :loud_sound: Add or update logs
          'analytics': 'ðŸ“ˆ', // :chart_with_upwards_trend: Add or update analytics
          'i18n': 'ðŸŒ',     // :globe_with_meridians: Internationalization
          'locale': 'ðŸŒ',   // :globe_with_meridians: Internationalization
          'responsive': 'ðŸ“±', // :iphone: Work on responsive design
          'mobile': 'ðŸ“±',   // :iphone: Work on responsive design
          'seo': 'ðŸ”ï¸',     // :mag: Improve SEO
          'types': 'ðŸ·ï¸',   // :label: Add or update types
          'typescript': 'ðŸ·ï¸', // :label: Add or update types
          'accessibility': 'â™¿ï¸', // :wheelchair: Improve accessibility
          'a11y': 'â™¿ï¸',     // :wheelchair: Improve accessibility
          'ux': 'ðŸš¸',       // :children_crossing: Improve user experience
          'usability': 'ðŸš¸', // :children_crossing: Improve user experience
          'architecture': 'ðŸ—ï¸', // :building_construction: Make architectural changes
          'contributor': 'ðŸ‘¥', // :busts_in_silhouette: Add or update contributor(s)
          'comment': 'ðŸ’¡',  // :bulb: Add or update comments in source code
          'comments': 'ðŸ’¡', // :bulb: Add or update comments in source code
          'text': 'ðŸ’¬',     // :speech_balloon: Add or update text and literals
          'assets': 'ðŸ±',   // :bento: Add or update assets
          
          // CUDA/GPU specific (keep existing CUDA mappings)
          'cuda': 'ðŸš€',     // :rocket: CUDA files (deploy/performance context)
          'gpu': 'âš¡ï¸',     // :zap: GPU related (performance context)
          'kernel': 'âš¡ï¸',  // :zap: Kernel optimizations (performance context)
          
          // General action words (fallbacks)
          'update': 'â¬†ï¸',   // :arrow_up: General updates (upgrade context)
          'add': 'âž•',      // :heavy_plus_sign: Adding files (dependency context)
          'delete': 'ðŸ”¥',   // :fire: Removing files
          'initial': 'ðŸŽ‰', // :tada: Initial commit
          'init': 'ðŸŽ‰',    // :tada: Initial commit
          'start': 'ðŸŽ‰',   // :tada: Begin a project
        };
        
        function hasGitemoji(message) {
          // Check if message already contains an emoji
          const emojiRegex = /[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u;
          return emojiRegex.test(message);
        }
        
        function detectCommitType(message, files) {
          const lowerMessage = message.toLowerCase();
          
          // Check conventional commit format first
          const conventionalMatch = message.match(/^(\w+)(\(.+\))?:/);
          if (conventionalMatch) {
            const type = conventionalMatch[1].toLowerCase();
            if (gitemojis[type]) {
              return gitemojis[type];
            }
          }
          
          // Check for specific keywords in message
          for (const [keyword, emoji] of Object.entries(gitemojis)) {
            if (lowerMessage.includes(keyword)) {
              return emoji;
            }
          }
          
          // Analyze changed files
          if (files) {
            if (files.some(f => f.includes('.cu') || f.includes('.cuh'))) {
              return gitemojis['cuda'];
            }
            if (files.some(f => f.includes('CMakeLists.txt') || f.includes('.cmake'))) {
              return gitemojis['cmake'];
            }
            if (files.some(f => f.includes('.github'))) {
              return gitemojis['github'];
            }
            if (files.some(f => f.toLowerCase().includes('readme'))) {
              return gitemojis['readme'];
            }
            if (files.some(f => f.includes('test'))) {
              return gitemojis['test'];
            }
            if (files.some(f => f.includes('doc'))) {
              return gitemojis['docs'];
            }
          }
          
          // Default based on action words
          if (lowerMessage.includes('add') || lowerMessage.includes('new')) {
            return gitemojis['add'];
          }
          if (lowerMessage.includes('remove') || lowerMessage.includes('delete')) {
            return gitemojis['remove'];
          }
          if (lowerMessage.includes('update') || lowerMessage.includes('modify')) {
            return gitemojis['update'];
          }
          if (lowerMessage.includes('initial') || lowerMessage.includes('first')) {
            return gitemojis['initial'];
          }
          
          // Default fallback
          return gitemojis['update'];
        }
        
        try {
          // Get all commits in the PR
          const prCommits = execSync('git log --pretty=format:"%H|%s" origin/main..HEAD', { encoding: 'utf8' })
            .trim().split('\n').filter(line => line);
          
          const suggestions = [];
          
          for (const commitLine of prCommits) {
            const [sha, message] = commitLine.split('|');
            
            // Skip if already has gitemoji
            if (hasGitemoji(message)) {
              console.log('âœ… Commit already has gitemoji:', message);
              continue;
            }
            
            // Get changed files in this commit
            let changedFiles = [];
            try {
              changedFiles = execSync(`git diff-tree --no-commit-id --name-only -r ${sha}`, { encoding: 'utf8' })
                .trim().split('\n').filter(f => f);
            } catch (e) {
              console.log('Could not get changed files for', sha);
            }
            
            // Detect appropriate gitemoji
            const emoji = detectCommitType(message, changedFiles);
            const newMessage = emoji + ' ' + message;
            
            suggestions.push({
              sha: sha.substring(0, 7),
              original: message,
              suggested: newMessage,
              emoji: emoji,
              files: changedFiles
            });
            
            console.log(`ðŸ“ ${sha.substring(0, 7)}: ${message}`);
            console.log(`âœ¨ Suggested: ${newMessage}`);
            console.log(`ðŸ“ Files: ${changedFiles.join(', ')}`);
            console.log('---');
          }
          
          // Write suggestions to file for the next step
          fs.writeFileSync('/tmp/gitemoji-suggestions.json', JSON.stringify(suggestions, null, 2));
          
          if (suggestions.length === 0) {
            console.log('ðŸŽ‰ All commits already have gitemojis!');
          } else {
            console.log(`ðŸ“‹ Found ${suggestions.length} commits that could use gitemojis`);
          }
          
        } catch (error) {
          console.error('âŒ Error:', error.message);
          // Don't fail the workflow, just log the error
          fs.writeFileSync('/tmp/gitemoji-suggestions.json', JSON.stringify([], null, 2));
        }
        EOF
        
        # Run the gitemoji analysis
        node analyze-gitemoji.js
        
    - name: Comment on PR with gitemoji suggestions
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Read suggestions from the analysis
          let suggestions = [];
          try {
            suggestions = JSON.parse(fs.readFileSync('/tmp/gitemoji-suggestions.json', 'utf8'));
          } catch (e) {
            console.log('No suggestions file found');
            return;
          }
          
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          // Check if we already commented about gitemoji
          const existingComment = comments.find(comment => 
            comment.user.login === 'github-actions[bot]' && 
            comment.body.includes('ðŸŽ¨ **Gitemoji Analysis**')
          );
          
          if (existingComment) {
            // Update existing comment
            if (suggestions.length === 0) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: 'ðŸŽ¨ **Gitemoji Analysis**: ðŸŽ‰ All commits in this PR already have appropriate gitemojis! Great job following the [gitmoji specification](https://gitmoji.dev/).'
              });
            } else {
              let body = 'ðŸŽ¨ **Gitemoji Analysis**: Found commits that could benefit from gitemojis based on the [official specification](https://gitmoji.dev/):\n\n';
              
              for (const suggestion of suggestions) {
                body += `**Commit \`${suggestion.sha}\`:**\n`;
                body += `- Original: \`${suggestion.original}\`\n`;
                body += `- Suggested: \`${suggestion.suggested}\`\n`;
                body += `- Files: ${suggestion.files.join(', ')}\n\n`;
              }
              
              body += 'ðŸ’¡ **Tip**: You can manually add these gitemojis to make your commit history more expressive!';
              
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            }
          } else {
            // Create new comment
            if (suggestions.length === 0) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'ðŸŽ¨ **Gitemoji Analysis**: ðŸŽ‰ All commits in this PR already have appropriate gitemojis! Great job following the [gitmoji specification](https://gitmoji.dev/).'
              });
            } else {
              let body = 'ðŸŽ¨ **Gitemoji Analysis**: Found commits that could benefit from gitemojis based on the [official specification](https://gitmoji.dev/):\n\n';
              
              for (const suggestion of suggestions) {
                body += `**Commit \`${suggestion.sha}\`:**\n`;
                body += `- Original: \`${suggestion.original}\`\n`;
                body += `- Suggested: \`${suggestion.suggested}\`\n`;
                body += `- Files: ${suggestion.files.join(', ')}\n\n`;
              }
              
              body += 'ðŸ’¡ **Tip**: You can manually add these gitemojis to make your commit history more expressive!';
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
          }
